---
AWSTemplateFormatVersion: '2010-09-09'

Resources:

  AccessCardApp:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      KeySchema:
      - AttributeName: PK
        KeyType: HASH
      - AttributeName: SK
        KeyType: RANGE
      AttributeDefinitions:
      - AttributeName: PK
        AttributeType: S
      - AttributeName: SK
        AttributeType: S
      - AttributeName: CardIdx
        AttributeType: S
      - AttributeName: ScannedBuildingIdx
        AttributeType: S
      GlobalSecondaryIndexes:
      - IndexName: "CardIssuedIdx"
        KeySchema: 
        - AttributeName: "CardIdx"
          KeyType: HASH
        - AttributeName: "PK"
          KeyType: RANGE
        Projection: 
          ProjectionType: "ALL"
      - IndexName: "OccupancyIdx"
        KeySchema: 
        - AttributeName: "ScannedBuildingIdx"
          KeyType: HASH
        - AttributeName: "PK"
          KeyType: RANGE
        Projection: 
          ProjectionType: "ALL"
      BillingMode: "PAY_PER_REQUEST"
      TableName: "lab3-access-card-app"
      # ProvisionedThroughput:
      #   ReadCapacityUnits: 1
      #   WriteCapacityUnits: 1

  # TableAccessCardAppReadCapacityScalableTarget:
  #   Type: AWS::ApplicationAutoScaling::ScalableTarget
  #   DependsOn: AccessCardApp
  #   Properties:
  #     ServiceNamespace: dynamodb
  #     ResourceId: table/access-card-app
  #     ScalableDimension: dynamodb:table:ReadCapacityUnits
  #     MinCapacity: 1
  #     MaxCapacity: 10
  #     RoleARN:
  #       Fn::Sub: arn:${AWS::Partition}:iam::${AWS::AccountId}:role/aws-service-role/dynamodb.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_DynamoDBTable

  # TableAccessCardAppReadCapacityScalingPolicy:
  #   Type: AWS::ApplicationAutoScaling::ScalingPolicy
  #   DependsOn: TableAccessCardAppReadCapacityScalableTarget
  #   Properties:
  #     ServiceNamespace: dynamodb
  #     ResourceId: table/access-card-app
  #     ScalableDimension: dynamodb:table:ReadCapacityUnits
  #     PolicyName: access-card-app-read-capacity-scaling-policy
  #     PolicyType: TargetTrackingScaling
  #     TargetTrackingScalingPolicyConfiguration:
  #       PredefinedMetricSpecification:
  #         PredefinedMetricType: DynamoDBReadCapacityUtilization
  #       ScaleOutCooldown: 60
  #       ScaleInCooldown: 60
  #       TargetValue: 70

  # TableAccessCardAppWriteCapacityScalableTarget:
  #   Type: AWS::ApplicationAutoScaling::ScalableTarget
  #   DependsOn: AccessCardApp
  #   Properties:
  #     ServiceNamespace: dynamodb
  #     ResourceId: table/access-card-app
  #     ScalableDimension: dynamodb:table:WriteCapacityUnits
  #     MinCapacity: 1
  #     MaxCapacity: 10
  #     RoleARN:
  #       Fn::Sub: arn:${AWS::Partition}:iam::${AWS::AccountId}:role/aws-service-role/dynamodb.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_DynamoDBTable

  # TableAccessCardAppWriteCapacityScalingPolicy:
  #   Type: AWS::ApplicationAutoScaling::ScalingPolicy
  #   DependsOn: TableAccessCardAppReadCapacityScalableTarget
  #   Properties:
  #     ServiceNamespace: dynamodb
  #     ResourceId: table/access-card-app
  #     ScalableDimension: dynamodb:table:WriteCapacityUnits
  #     PolicyName: access-card-app-write-capacity-scaling-policy
  #     PolicyType: TargetTrackingScaling
  #     TargetTrackingScalingPolicyConfiguration:
  #       PredefinedMetricSpecification:
  #         PredefinedMetricType: DynamoDBWriteCapacityUtilization
  #       ScaleOutCooldown: 60
  #       ScaleInCooldown: 60
  #       TargetValue: 70

Outputs:

  AccessCardAppTableName:
    Description: "DynamoDB AccessCardApp Name"
    Value: !Ref AccessCardApp
    Export:
      Name: !Sub "${AWS::StackName}-AccessCardAppTableName"
